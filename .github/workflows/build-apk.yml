name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Create gradlew script
        run: |
          cat > gradlew << 'EOF'
          #!/usr/bin/env sh
          ##############################################################################
          ##
          ##  Gradle start up script for UN*X
          ##
          ##############################################################################
          PRG="$0"
          while [ -h "$PRG" ] ; do
              ls=`ls -ld "$PRG"`
              link=`expr "$ls" : '.*-> \(.*\)$'`
              if expr "$link" : '/.*' > /dev/null; then
                  PRG="$link"
              else
                  PRG=`dirname "$PRG"`"/$link"
              fi
          done
          SAVED="`pwd`"
          cd "`dirname \"$PRG\"`/" >/dev/null
          APP_HOME="`pwd -P`"
          cd "$SAVED" >/dev/null
          APP_NAME="Gradle"
          APP_BASE_NAME=`basename "$0"`
          DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
          MAX_FD="maximum"
          warn () {
              echo "$*"
          }
          die () {
              echo
              echo "$*"
              echo
              exit 1
          }
          cygwin=false
          msys=false
          darwin=false
          nonstop=false
          case "`uname`" in
            CYGWIN* )
              cygwin=true
              ;;
            Darwin* )
              darwin=true
              ;;
            MINGW* )
              msys=true
              ;;
            NONSTOP* )
              nonstop=true
              ;;
          esac
          CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
          if [ -n "$JAVA_HOME" ] ; then
              if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
                  JAVACMD="$JAVA_HOME/jre/sh/java"
              else
                  JAVACMD="$JAVA_HOME/bin/java"
              fi
              if [ ! -x "$JAVACMD" ] ; then
                  die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME"
              fi
          else
              JAVACMD="java"
              which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH."
          fi
          if [ "$cygwin" = "false" -a "$darwin" = "false" -a "$nonstop" = "false" ] ; then
              MAX_FD_LIMIT=`ulimit -H -n`
              if [ $? -eq 0 ] ; then
                  if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
                      MAX_FD="$MAX_FD_LIMIT"
                  fi
                  ulimit -n $MAX_FD
              fi
          fi
          if $darwin; then
              GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
          fi
          if [ "$cygwin" = "true" -o "$msys" = "true" ] ; then
              APP_HOME=`cygpath --path --mixed "$APP_HOME"`
              CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`
              JAVACMD=`cygpath --unix "$JAVACMD"`
              i=0
              for arg in "$@" ; do
                  CHECK=`echo "$arg"|egrep -c "(^(/|Applications|System|Volumes|Users|tmp|private))"`
                  if [ $CHECK -ne 0 ] ; then
                      eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
                  else
                      eval `echo args$i`="\"$arg\""
                  fi
                  i=`expr $i + 1`
              done
              case $i in
                  0) set -- ;;
                  1) set -- "$args0" ;;
                  2) set -- "$args0" "$args1" ;;
                  3) set -- "$args0" "$args1" "$args2" ;;
                  4) set -- "$args0" "$args1" "$args2" "$args3" ;;
                  5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
                  6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
                  7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
                  8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
                  9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
              esac
          fi
          save () {
              for i do printf %s\\n "$i" | sed "s/'/'\\\\''/g;1s/^/'/;\$s/\$/' \\\\/" ; done
               echo " "
           }
           APP_ARGS=`save "$@"`
           ARGS=("$JAVACMD" $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "-Dorg.gradle.appname=$APP_BASE_NAME" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS")
           exec "${ARGS[@]}"
           EOF
           chmod +x gradlew
       - name: Create gradle-wrapper.properties
         run: |
           mkdir -p gradle/wrapper
           cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
           distributionBase=GRADLE_USER_HOME
           distributionPath=wrapper/dists
           distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-bin.zip
           networkTimeout=10000
           validateDistributionUrl=true
           zipStoreBase=GRADLE_USER_HOME
           zipStorePath=wrapper/dists
           EOF
       - name: Download gradle-wrapper.jar
         run: |
           curl -o gradle/wrapper/gradle-wrapper.jar https://repo1.maven.org/maven2/org/gradle/wrapper/gradle-wrapper/7.5/gradle-wrapper-7.5.jar
       - name: Build with Gradle
         run: ./gradlew assembleDebug
       - name: Upload APK
         uses: actions/upload-artifact@v4
         with:
           name: my-app-apk
           path: app/build/outputs/apk/debug/app-debug.apk
